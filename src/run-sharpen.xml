<?xml version="1.0"?>
<project name="CouchbaseLite.Net" default="sharpen-couchbase-lite">
	<property file="sharpen.properties" />


  <!-- Main target -->
  <target name="sharpen-couchbase-lite-prep" depends="clean">

    <property name="clean.dir" location="sharpen" />

    <!-- Copy java files to the resource folder -->
    <copy todir="${clean.dir}/java">
	
	  <!-- CHECK THIS SETTING 
	  	   Make sure that the fileset dir below points to the root folder 
	       containing the Java source code files you want to convert to C#
	  -->
      <fileset dir="main/java">
        <include name="**/*.java" />
      </fileset>
      <fileset dir="main/gen">
        <include name="**/*.java" />
      </fileset>
      </copy>

    <!-- Apply our custom patches -->
	<patch patchfile="patches/FixJavaEnums.patch" strip="1" dir="sharpen" />    

  </target>

	<macrodef name="sharpen">
		<attribute name="workspace" />
		<attribute name="resource" />

		<element name="args" optional="yes" />

		<sequential>
			<exec executable="${file.jvm.jdk1.5}" failonerror="true" timeout="1800000">
        <arg value="-verbose" />
        <arg value="-Xms256m" />
				<arg value="-Xmx512m" />
				<arg value="-cp" />
				<arg value="${eclipse.startup.jar}" />
				<arg value="org.eclipse.core.launcher.Main" />
				<arg value="-data" />
				<arg file="@{workspace}" />
				<arg value="-application" />
				<arg value="sharpen.core.application" />
		        <arg value="-header" />
		        <arg file="header.txt" />
				<arg value="@{resource}" />

				<args />

			</exec>
		</sequential>
	</macrodef>


  <!-- Main target -->
  <target name="sharpen-couchbase-lite" depends="sharpen-couchbase-lite-prep">

    <property name="target.dir" location="${dir.workspace}" />

    <!-- Sharpen java files -->
    <sharpen workspace="${target.dir}" resource="sharpen/java">
      <args>

	  	<!-- CHECK THIS SETTING 
	  	   Make sure that you have an arg value/path element for 
	  	   EVERY external jar file that your Java project references.
	  	   You can get the list of these by right clicking on the project,
	  	   choosing Build Path -> Configure Build Path, and then checking the Libraries tab.
	  	-->
        <!-- classpath needed for java sources compilation -->
        <arg value="-cp" />
		<arg path="/Users/zgramana/Library/Developer/Xamarin/android-sdk-mac_x86/platforms/android-18/android.jar" />
		<arg value="-cp" />
		<arg path="../libs/android-support-v4.jar" />
		<arg value="-cp" />
		<arg path="../libs/td_collator_so.jar" />
		<arg value="-cp" />
 		<arg path="../libs/jackson-core-asl-1.9.13.jar" /> 
		<arg value="-cp" />
		<arg path="../libs/jackson-mapper-asl-1.9.13.jar" />

						
        <!-- Sharpen options are defined in a separate file -->
        <arg value="@sharpen-all-options" />
      </args>
    </sharpen>
  </target>

  <!-- Remove resources from the previous convertion run -->
  <target name="clean" description="Delete all generated files">
    <delete failonerror="false" dir=".metadata" description="Removing the Eclipse metadata directory" />
    <delete failonerror="false" includeemptydirs="true" description="Removing all generated files">
      <fileset dir="sharpen">
        <include name="**/*" />
        <exclude name="**/lib/*" />
      </fileset>
    </delete>
  </target>
</project>
